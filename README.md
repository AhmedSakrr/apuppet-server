# aPuppet

## Описание

Система реализует возможность удалённого управления администратором устройствами на базе Android из веб-приложения. 

В состав системы входят:

- [Janus](https://janus.conf.meetecho.com/). Медиасервер
- [nginx](https://nginx.org/). Веб-сервер общего назначения
- [certbot](https://certbot.eff.org/). Агент для управления SSL-сертификатами, выпускаемыми [LetsEncrypt](https://letsencrypt.org/)
- web-admin. Веб-приложение администратора для удалённого управления устройствами. После установки aPuppet оно будет доступно по адресу: `apuppet.my-company.org/web-admin/`


## Развёртывание

### Требования к системе

- Архитектура `x84_64` / `amd64`
- ОС Ubuntu, возможные варианты:
    - Ubuntu Focal `20.04 LTS`
	- Ubuntu Bionic `18.04 LTS` 
	- Ubuntu Xenial `16.04 LTS`
- Командная оболочка `bash`

Полностью протестирована и подтверждена работоспособность на хостинге DigitalOcean со следующими версиями Ubuntu:

- Ubuntu Focal 20.04 LTS x64
- Ubuntu Bionic 18.04.3 LTS x64
- Ubuntu Xenial 16.04.6 LTS x64

### Подготовка системы

Получим или обновим списки пакетов системы:

`sudo apt update`

Установим git, если он ещё не установлен:

`sudo apt install -y git`

### Установка aPuppet

#### Получение исходного кода

Систему необходимо загрузить на сервер посредством `git` из репозитория https://gitlab.com/headwind/remote-control.

Прежде всего, обратитесь к владельцу репозитория для получения доступа на скачивание системы.

Предварительно создайте SSH-ключ для доступа к репозиторию:

`ssh-keygen -t rsa -b 4096 -C "administrator@my-company.org"`

Вместо `administrator@my-company.org` укажите свою почту, на все остальные запросы команды достаточно просто нажимать `Enter`

После успешной генерации ключа, выведите его на экран, скопируйте и отправьте владельцу репозитория, чтобы он добавил ваш ключ для доступа к скачиванию системы:

`cat ~/.ssh/id_rsa.pub`

После того, как вам будет предоставлен доступ, можно склонировать систему:

`git pull git@gitlab.com:headwind/remote-control.git`

Если при клонировании спросит про сертификат, необходимо ввести `yes`.

#### Перед установкой

Перейдём в папку с проектом:

`cd remote-control`

Отредактируйте любым удобным способом файл `config.yaml`, указав название домена и электронную почту администратора: 

```
---
hostname: "apuppet.my-company.org"
email: "administrator@my-company.org"
```

_Важно: aPuppet создан для работы на выделенном доменном имени. Подходит как обычный домен вида `yourdomain.ru`, так и поддомен любого уровня. При установке система проверяет, что указанное в файле `config.yaml` доменное имя реально существует и указывает на ваш сервер, иначе установка прекращается. Поэтому перед запуском установки создайте и настройте отдельный домен или поддомен любого уровня так, чтобы DNS указывал на внешний IP адрес вышего сервера._

#### Установка

`sudo ./install.sh`

После успешного выполнения данной команды aPuppet будет полностью сконфигурирован, установлен и запущен.

Теперь вы можете зайти в веб-приложение администратора по адресу `apuppet.my-company.org/web-admin/`


## Подробности

### Установка

Скрипт install.sh:

- проверяет тип и версию ОС. При обнаружении запуска на любой другой ОС, кроме Ubuntu LTS версий 16.04, 18.04, 20.04 скрипт прерывает установку aPuppet
- устанавливает Ansible нужной версии
- запускает ansible-плейбук deploy/install.sh, который полностью устанавливает aPuppet и нужные зависимости
- запускает ansible-плейбук deploy/start.sh, который конфигурирует aPuppet и запускает его

#### Отдельно про Ansible

Для работы ansible-плейбуков требуется наличие Ansible версии 2.9.x[^ansible-version-warning].

[^ansible-version-warning] В будущем при установке Ansible из официального PPA может возникнуть ситуация, когда нужная нам версия 2.9.x заменится версией 2.10.x (или старше). В таком случае система развёртывания продукта работать не будет (в версии 2.10 произошли существенные изменения). Обратитесь к разработчику aPuppet, чтобы он предоставил актуальные на тот момент скрипты развёртывания продукта.

Для Ubuntu Focal (20.04 LTS) в репозитории имеется нужная версия. Для Ubuntu Xenial (16.04 LTS) и Ubuntu Bionic (18.04 LTS) системный пакет не подходит (устарел), поэтому нужная версия пакета устанавливается из [официального PPA](https://launchpad.net/~ansible/+archive/ubuntu/ansible)

Подробнее об установке Ansible можно узнать из [официальной документации](https://docs.ansible.com/ansible/2.9/installation_guide/intro_installation.html).

### Конфигурирование

Существует несколько файлов конфигурирования

- `config.yaml`. Локальная конфигурация aPuppet. Все изменения по конфигурации вашей установки aPuppet необходимо производить здесь
- `deploy/config.build.yaml`. Конфигурация сборки и установки aPuppet. Здесь что-то изменять крайне не рекомендуется, так как влияет на саму сборку системы.
- `deploy/config.defaults.yaml`. Конфигурация aPuppet по умолчанию

Список доступных параметров конфигурации, их значений по умолчанию и описаний:
- `hostname`. Домен любого уровня, на котором будет работать aPuppet
- `email`. Электронная почта администратора. Пока используется при формировании сертификата LetsEncrypt как электронная почта администратора для получения важных уведомлений
- для Janus
    - `api_http: true`. Разрешен ли REST API по незащищённому протоколу HTTP. Рекомендуется оставить для работы с Nginx
    - `api_http_port: 8088`. Порт для REST API по HTTP 
    - `api_https: true`. Разрешён ли REST API по защищённому протоколу HTTPS
    - `api_https_port: 8089`. Порт для REST API по HTTPS
    - `admin_api_https: false`. Разрешён ли Admin REST API по протоколу HTTPS. Сейчас API для администрирования никак не используется, поэтому не рекомендуется его включать.
    - `admin_api_https_port: 7889`. Порт для Admin REST API по HTTPS
    - `api_wss: true`. Разрешён ли Websockets API по протоколу HTTPS - WSS. Рекомендуется оставить для более быстрого взаимодействия сервера и web-admin
    - `api_wss_port: 8989`. Порт для Websockets API по HTTPS
- для Nginx
    - `is_nginx_enabled: true`. Включён ли nginx. Если выключен, для работы с web-admin необходимо разместить папку `web-admin` на вашем веб-сервере
    - `web_http_port: 80`. Порт для HTTP
    - `web_https_port: 443`. Порт для HTTPS
- для RTP
    - `rtp_port_range: 10000-10500`. Диапазон портов UDP для трансляции видео.

- для SSL и Certbot
    - `is_certbot_enabled: true`. Включён ли Certbot. Если выключен, и не предоставлены данные вашего ssl-сертификата, все службы функционируют без защиты соединений.
    - `share_email: true`. Предоставлять ли вашу электронную почту [EFF](https://www.eff.org/) (Electronic Frontier Foundation) - организации-разработчику Certbot

### Варианты запуска и использования

Есть несколько вариантов установки aPuppet

#### Janus, Nginx, Certbot

Установка всех компонентов системы, формирование и регулярное обновление SSL-сертификата, необходимого для работы aPuppet.

Это вариант по умолчанию. В файле `config.yaml` не должно быть параметров `is_certbot_enabled` и `is_nginx_enabled`, или они должны иметь значение `true`.

#### Janus, Nginx

Если у вас имеется свой сертификат, вы можете использовать его. Эта возможность доступна с использованием расширенной версии aPuppet, за подробностями обратитесь к разработчику.

Для реализации такого варианта нужно выключить certbot в файле `config.yaml`:

```
is_certbot_enabled: false
```

#### Только Janus

Устанавливается только медиасервер. Вариант подходит, если у вас уже есть свой сертификат и развёрнутый сайт, куда вы хотите встроить веб-админку продукта.

Для реализации такого варианта нужно выключить certbot и nginx в файле `config.yaml`:

```
is_certbot_enabled: false
is_nginx_enabled: false
```

